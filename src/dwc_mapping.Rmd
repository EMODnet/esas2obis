---
title: "Darwin Core mapping of ESAS data"
author:
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

This document describes how (and contains the code to) transform European Seabirds at Sea (ESAS) data to an [OBIS-ENV Darwin Core Archive](https://obis.org/manual/dataformat/#obis-env-data) that can be uploaded to an IPT.

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Install required libraries (if not yet installed):

```{r}
installed <- rownames(installed.packages())
required <- c("magrittr", "here", "glue", "readr", "DBI", "frictionless")
if (!all(required %in% installed)) {
  install.packages(required[!required %in% installed])
}
```

Load libraries:

```{r message = FALSE}
library(magrittr)       # To use pipes
library(here)           # To find files
library(glue)           # To insert variables in strings
library(readr)          # To write files
library(DBI)            # To create and query databases
library(frictionless)   # To read and write Frictionless Data Packages
```

# Read source data

For now, the source data are provided manually. These were converted to a Frictionless Data Package with [frictionless](https://docs.ropensci.org/frictionless):

```{r eval=FALSE}
source_data <- frictionless::create_package()

# Assign data resources
source_data <-
  source_data %>%
  frictionless::add_resource(resource_name = "campaigns", data = here::here("data", "raw", "CAMPAIGNS_BE_ICES_2022.csv"), schema = "https://raw.githubusercontent.com/ices-tools-dev/esas/main/_data/table-schemas/campaign.yaml") %>%
  frictionless::add_resource(resource_name = "samples", data = here::here("data", "raw", "SAMPLES_BE_ICES_2022.csv"), schema = "https://raw.githubusercontent.com/ices-tools-dev/esas/main/_data/table-schemas/sample.yaml") %>%
  frictionless::add_resource(resource_name = "positions", data = here::here("data", "raw", "POSITIONS_BE_ICES_2022.csv"), schema = "https://raw.githubusercontent.com/ices-tools-dev/esas/main/_data/table-schemas/position.yaml") %>%
  frictionless::add_resource(resource_name = "observations", data = here::here("data", "raw", "OBSERVATIONS_BE_ICES_2022.csv"), schema = "https://raw.githubusercontent.com/ices-tools-dev/esas/main/_data/table-schemas/observation.yaml")

# Assign species list as extra resource
source_data <- add_resource(
  source_data,
  resource_name = "species",
  data = readr::read_tsv("https://raw.githubusercontent.com/ices-tools-dev/esas/main/_data/vocabularies/species.tsv", col_types = "iccicicc"),
  delim = "\t"
)

# Write to disk
frictionless::write_package(source_data, here::here("data", "raw"))
```

Read source files:

```{r}
source_data  <- frictionless::read_package(here::here("data", "raw", "datapackage.json"))
campaigns    <- frictionless::read_resource(source_data, "campaigns")
samples      <- frictionless::read_resource(source_data, "samples")
positions    <- frictionless::read_resource(source_data, "positions")
observations <- frictionless::read_resource(source_data, "observations")
species      <- frictionless::read_resource(source_data, "species")
```

## Create database

Create a SQLite database with the source data, so it can be queried with SQL in the next steps:

```{r}
esas_db <- DBI::dbConnect(RSQLite::SQLite(), ":memory:")
DBI::dbWriteTable(esas_db, "campaigns", campaigns)
DBI::dbWriteTable(esas_db, "samples", samples)
DBI::dbWriteTable(esas_db, "positions", positions)
DBI::dbWriteTable(esas_db, "observations", observations)
DBI::dbWriteTable(esas_db, "species", species)
```

## Darwin Core mapping

The Darwin Core mapping follows the recommendations of the [OBIS Darwin Core manual](https://obis.org/manual/darwincore/) and is structured as [OBIS-ENV-DATA](https://obis.org/manual/dataformat/#obis-env-data).

Create DwC Event core:

```{r}
dwc_event_sql <- glue::glue_sql(readr::read_file(here::here("sql", "dwc_event.sql")), .con = esas_db)
dwc_event <- DBI::dbGetQuery(esas_db, dwc_event_sql)
```

Create DwC Occurrence extension:

```{r}
dwc_occurrence_sql <- glue::glue_sql(readr::read_file(here::here("sql", "dwc_occurrence.sql")), .con = esas_db)
dwc_occurrence <- DBI::dbGetQuery(esas_db, dwc_occurrence_sql)
```

Create DwC Measurement or fact extension:

```{r}
dwc_mof_sql <- glue::glue_sql(readr::read_file(here::here("sql", "dwc_mof.sql")), .con = esas_db)
dwc_mof <- DBI::dbGetQuery(esas_db, dwc_mof_sql)
```

## Write data to CSV

```{r}
write_csv(dwc_event, here("data", "processed", "event.csv"), na = "")
write_csv(dwc_occurrence, here("data", "processed", "occurrence.csv"), na = "")
write_csv(dwc_mof, here("data", "processed", "mof.csv"), na = "")
```
