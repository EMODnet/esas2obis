---
title: "Darwin Core mapping of ESAS data"
author:
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

This document describes how (and contains the code to) transform European Seabirds at Sea (ESAS) data to an [OBIS-ENV Darwin Core Archive](https://obis.org/manual/dataformat/#obis-env-data) that can be uploaded to an IPT.

# Setup 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = TRUE)
```

Install required libraries (if not yet installed):

```{r}
installed <- rownames(installed.packages())
required <- c("magrittr", "here", "glue", "readr", "DBI", "icesVocab")
if (!all(required %in% installed)) {
  install.packages(required[!required %in% installed])
}
```

Load libraries:

```{r message = FALSE}
library(magrittr)       # To use pipes
library(here)           # To find files
library(glue)           # To insert variables in strings
library(readr)          # To write files
library(DBI)            # To create and query databases
library(icesVocab)      # To get code lists
```

# Read source data

For now, the source data were provided manually and stored in `data/raw`. **TODO**: replace with querying from ESAS endpoint.

Read source files:

```{r}
# All columns are read as characters for easier import into SQLite: https://stackoverflow.com/a/13462536/2463806
campaigns <- readr::read_csv(here::here("data", "raw", "CAMPAIGNS_BE_ICES_2022.csv"), col_types = cols(.default = "c"))
samples <- readr::read_csv(here::here("data", "raw", "SAMPLES_BE_ICES_2022.csv"), col_types = cols(.default = "c"))
positions <- readr::read_csv(here::here("data", "raw", "POSITIONS_BE_ICES_2022.csv"), col_types = cols(.default = "c"))
observations <- readr::read_csv(here::here("data", "raw", "OBSERVATIONS_BE_ICES_2022.csv"), col_types = cols(.default = "c"))
```

## Read code lists

Load ESAS species list from GitHub repository:

```{r}
species <- readr::read_tsv("https://raw.githubusercontent.com/ices-tools-dev/esas/main/_data/vocabularies/species.tsv", col_types = "iccicicc")
```

Get code lists from ICES vocabularies API:

```{r eval=FALSE}
shipc <- getCodeList("SHIPC")
platformclass <- getCodeList(URLencode("Platform Class"))
platformside <- getCodeList("PlatformSide")
bdcountmethod <- getCodeList("BD_CountMethod")
targettaxa <- getCodeList("TargetTaxa")
useofbinoculars <- getCodeList("UseOfBinoculars")
beaufort <- getCodeList("Beaufort")
visibility <- getCodeList("Visibility")
behaviour <- getCodeList("Behaviour")
```

## Create database

Create a SQLite database with the source data and code lists, so it can be queried with SQL in the next steps:

```{r}
esas_db <- DBI::dbConnect(RSQLite::SQLite(), ":memory:")

# Import data
DBI::dbWriteTable(esas_db, "campaigns", campaigns)
DBI::dbWriteTable(esas_db, "samples", samples)
DBI::dbWriteTable(esas_db, "positions", positions)
DBI::dbWriteTable(esas_db, "observations", observations)

# Import code lists
DBI::dbWriteTable(esas_db, "species", species)
DBI::dbWriteTable(esas_db, "shipc", shipc)
DBI::dbWriteTable(esas_db, "platformclass", platformclass)
DBI::dbWriteTable(esas_db, "platformside", platformside)
DBI::dbWriteTable(esas_db, "bdcountmethod", bdcountmethod)
DBI::dbWriteTable(esas_db, "targettaxa", targettaxa)
DBI::dbWriteTable(esas_db, "useofbinoculars", useofbinoculars)
DBI::dbWriteTable(esas_db, "beaufort", beaufort)
DBI::dbWriteTable(esas_db, "visibility", visibility)
DBI::dbWriteTable(esas_db, "behaviour", behaviour)
```

Set filter: **TODO**: remove for production use.

```{r}
campaign_id <- 110000153
```

## Darwin Core mapping

The Darwin Core mapping follows the recommendations of the [OBIS Darwin Core manual](https://obis.org/manual/darwincore/) and is structured as [OBIS-ENV-DATA](https://obis.org/manual/dataformat/#obis-env-data).

Create [Event](https://rs.gbif.org/core/dwc_event_2022-02-02.xml) core:

```{r}
dwc_event_sql <- glue::glue_sql(readr::read_file(here::here("sql", "dwc_event.sql")), .con = esas_db)
dwc_event <- DBI::dbGetQuery(esas_db, dwc_event_sql)
```

Create [Occurrence](https://rs.gbif.org/core/dwc_occurrence_2022-02-02.xml) extension:

```{r}
dwc_occurrence_sql <- glue::glue_sql(readr::read_file(here::here("sql", "dwc_occurrence.sql")), .con = esas_db)
dwc_occurrence <- DBI::dbGetQuery(esas_db, dwc_occurrence_sql)
```

Create [Extended Measurement Or Facts](https://rs.gbif.org/extension/obis/extended_measurement_or_fact.xml) extension:

```{r}
dwc_emof_sql <- glue::glue_sql(readr::read_file(here::here("sql", "dwc_emof.sql")), .con = esas_db)
dwc_emof <- DBI::dbGetQuery(esas_db, dwc_emof_sql)
```

## Save data to CSV

```{r}
write_csv(dwc_event, here::here("data", "processed", "event.csv"), na = "")
write_csv(dwc_occurrence, here::here("data", "processed", "occurrence.csv"), na = "")
write_csv(dwc_emof, here::here("data", "processed", "emof.csv"), na = "")
```
